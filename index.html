<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Do'koni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color, #f3f4f6); color: var(--tg-theme-text-color, #1f2937); }
        .card { background-color: var(--tg-theme-secondary-bg-color, #ffffff); }
        .btn-primary { background-color: var(--tg-theme-button-color, #3b82f6); color: var(--tg-theme-button-text-color, #ffffff); }
    </style>
</head>
<body class="p-4 select-none">

    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-xl font-bold">Salom, <span id="user-name">...</span></h1>
            <p class="text-xs opacity-70">Xush kelibsiz</p>
        </div>
        <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg font-bold text-sm">
            ðŸ’Ž <span id="user-score">0</span>
        </div>
    </header>

    <div id="products-container" class="grid grid-cols-2 gap-4">
        </div>

    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg text-sm hidden shadow-lg z-50 transition-opacity duration-300">
        Xabar
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // User ID ni Telegramdan olamiz
        // Agar browserda test qilsangiz, pastdagi qatorni o'zgartiring: const userId = 12345678;
        const userId = tg.initDataUnsafe?.user?.id;

        const API_URL = ""; // Agar server va webapp bitta joyda bo'lsa bo'sh qoladi

        // 1. User ma'lumotlarini yuklash
        async function loadUser() {
            if(!userId) return;
            try {
                const response = await fetch(`${API_URL}/api/user?user_id=${userId}`);
                const data = await response.json();
                document.getElementById('user-name').innerText = data.first_name || "Foydalanuvchi";
                document.getElementById('user-score').innerText = data.score;
            } catch (e) {
                console.error("User yuklashda xato:", e);
            }
        }

        // 2. Mahsulotlarni yuklash
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/api/products`);
                const products = await response.json();
                
                const container = document.getElementById('products-container');
                container.innerHTML = "";

                if (products.length === 0) {
                    container.innerHTML = "<p class='col-span-2 text-center opacity-50'>Mahsulotlar yo'q</p>";
                    return;
                }

                products.forEach(prod => {
                    const card = document.createElement('div');
                    card.className = "card p-4 rounded-xl shadow-sm flex flex-col items-center text-center";
                    // Agar rasm bo'lmasa standart rasm qo'yamiz
                    const img = "https://cdn-icons-png.flaticon.com/512/263/263142.png"; 
                    
                    card.innerHTML = `
                        <img src="${img}" class="w-14 h-14 mb-3 object-cover rounded-md">
                        <h3 class="font-bold text-md leading-tight mb-1">${prod.name}</h3>
                        <p class="text-xs opacity-70 mb-3 h-8 overflow-hidden line-clamp-2">${prod.description}</p>
                        <div class="mt-auto w-full">
                            <span class="block font-bold text-md mb-2 text-blue-600">${prod.price} ball</span>
                            <button onclick="buyItem(${prod.id}, ${prod.price})" 
                                class="btn-primary w-full py-2 rounded-lg font-medium text-sm active:opacity-80 transition">
                                Sotib olish
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                console.error("Mahsulot yuklashda xato:", e);
            }
        }

        // 3. Sotib olish funksiyasi (Serverga so'rov yuboradi)
        async function buyItem(productId, price) {
            if(!userId) {
                showToast("âŒ Telegram orqali kiring!");
                return;
            }

            // Tasdiqlash
            tg.showConfirm(`Rostdan ham ${price} ballga sotib olasizmi?`, async (confirm) => {
                if(confirm) {
                    try {
                        const response = await fetch(`${API_URL}/api/buy`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: userId, product_id: productId })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showToast("âœ… " + result.message);
                            document.getElementById('user-score').innerText = result.new_score;
                            
                            // Botga xabar yuborish (ixtiyoriy, agar bot ichida ham xabar chiqsin desangiz)
                            // tg.sendData(JSON.stringify({action: 'bought', id: productId})); 
                        } else {
                            showToast("âŒ " + result.message);
                        }
                    } catch (e) {
                        showToast("âŒ Server xatosi!");
                    }
                }
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Dastur ishga tushishi
        loadUser();
        loadProducts();

    </script>
</body>
</html>
